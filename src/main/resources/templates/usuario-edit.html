<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Editar Usuario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    /* Botón flotante para volver al inicio */
    .home-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .home-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      color: white;
      text-decoration: none;
    }
  </style>
</head>
<body>
  
  <!-- Botón flotante para volver al inicio -->
  <a href="/dashboard" class="home-btn">
    <i class="bi bi-house-door"></i> Inicio
  </a>
  <div class="container py-4">
    <h1 class="text-center mb-4">Editar Usuario</h1>
    
    <div th:if="${mensaje}" class="alert alert-success">
      <span th:text="${mensaje}"></span>
    </div>
    <div th:if="${error}" class="alert alert-danger">
      <span th:text="${error}"></span>
    </div>

    <!-- Formulario de edición -->
    <div class="card">
      <div class="card-header bg-warning">
        <h5 class="mb-0">Editar Información del Usuario</h5>
      </div>
      <div class="card-body">
        <form th:action="@{'/usuarios/' + ${usuario.id}}" method="post" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="legajo" class="form-label">Legajo</label>
              <input type="text" id="legajo" name="legajo" class="form-control" 
                     th:value="${usuario.legajo}" required 
                     oninput="this.value = this.value.toUpperCase()" 
                     style="text-transform: uppercase;" />
            </div>
            <div class="col-md-6 mb-3">
              <label for="nombre" class="form-label">Nombre</label>
              <input type="text" id="nombre" name="nombre" class="form-control" 
                     th:value="${usuario.nombre}" required 
                     oninput="this.value = this.value.toUpperCase()" 
                     style="text-transform: uppercase;" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="apellido" class="form-label">Apellido</label>
              <input type="text" id="apellido" name="apellido" class="form-control" 
                     th:value="${usuario.apellido}" required 
                     oninput="this.value = this.value.toUpperCase()" 
                     style="text-transform: uppercase;" />
            </div>
            <div class="col-md-6 mb-3">
              <label for="telefono" class="form-label">Teléfono</label>
              <input type="text" id="telefono" name="telefono" class="form-control" 
                     th:value="${usuario.telefono}" 
                     oninput="this.value = this.value.toUpperCase()" 
                     style="text-transform: uppercase;" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="correoElectronico" class="form-label">Correo Electrónico</label>
              <input type="email" id="correoElectronico" name="correoElectronico" class="form-control" 
                     th:value="${usuario.correoElectronico}" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="direccion" class="form-label">Dirección</label>
              <input type="text" id="direccion" name="direccion" class="form-control" 
                     th:value="${usuario.direccion}" 
                     oninput="this.value = this.value.toUpperCase()" 
                     style="text-transform: uppercase;" />
            </div>
          </div>

          <div class="mb-3">
            <label for="site" class="form-label">Site</label>
            <select id="site" name="site" class="form-select" required>
              <option th:each="s : ${T(com.registro.model.Site).values()}"
                      th:value="${s}" th:text="${s.label}"
                      th:selected="${s} == ${usuario.site}">
              </option>
            </select>
          </div>

          <!-- Archivos Existentes -->
          <div class="mb-3">
            <label class="form-label">Archivos Existentes</label>
            <div th:if="${usuario.archivos != null and !usuario.archivos.empty}">
              <div th:each="archivo : ${usuario.archivos}" class="border rounded p-2 mb-2">
                <div class="card">
                  <div class="card-body">
                    <strong th:text="${archivo.nombreOriginal}">archivo.pdf</strong><br>
                    <small class="text-muted" th:text="${archivo.path}">path/archivo.pdf</small><br>
                    <a th:href="@{'/usuarios/archivos/descargar/' + ${archivo.id}}" class="btn btn-sm btn-primary me-2">
                      Descargar
                    </a>
                    <a th:href="@{'/usuarios/archivos/eliminar/' + ${archivo.id} + '?usuarioId=' + ${usuario.id}}" 
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('¿Eliminar archivo?')">
                      Eliminar
                    </a>
                  </div>
                </div>
              </div>
            </div>
            <div th:unless="${usuario.archivos != null and !usuario.archivos.empty}" class="alert alert-info">
              No hay archivos asociados a este usuario.
            </div>
          </div>

          <!-- Agregar Nuevos Archivos -->
          <div class="mb-3">
            <label class="form-label">Agregar Nuevos Archivos</label>
            <div class="d-flex gap-2 mb-2">
              <input type="file" id="fileInput" class="form-control" accept="*/*">
              <button type="button" class="btn btn-outline-primary" onclick="addFile()">
                <i class="bi bi-plus-circle"></i> Agregar
              </button>
              <button type="button" class="btn btn-outline-danger" onclick="clearAllFiles()">
                <i class="bi bi-trash"></i> Limpiar Todo
              </button>
            </div>
            
            <!-- Lista de archivos seleccionados -->
            <div id="fileList" class="border rounded p-3" style="min-height: 60px; background-color: #f8f9fa;">
              <small class="text-muted">No hay archivos seleccionados</small>
            </div>
            
            <!-- Input oculto para enviar archivos -->
            <input type="file" name="archivos" id="hiddenFileInput" multiple style="display: none;">
          </div>

          <!-- Equipos Informáticos -->
          <div class="mb-3">
            <label class="form-label">Equipos Informáticos</label>
            
            <!-- Equipos existentes -->
            <div th:if="${usuario.equiposInformaticos != null and !usuario.equiposInformaticos.empty}" class="mb-3">
              <h6>Equipos Asignados:</h6>
              <div th:each="equipo : ${usuario.equiposInformaticos}" class="alert alert-info d-flex justify-content-between align-items-center mb-2">
                <div>
                  <strong th:text="${equipo.tipo}">Laptop</strong> - 
                  <span th:text="${equipo.marca}">Dell</span> 
                  <span th:text="${equipo.modelo}">Inspiron</span><br>
                  <small class="text-muted">
                    Serie: <span th:text="${equipo.numeroSerie ?: 'N/A'}">123456</span> | 
                    Estado: <span th:text="${equipo.estado}">ACTIVO</span>
                  </small>
                </div>
                <div>
                  <button type="button" class="btn btn-sm btn-outline-info me-1" 
                          onclick="verDetallesEquipo(this)"
                          th:data-id="${equipo.id}"
                          th:data-tipo="${equipo.tipo}"
                          th:data-marca="${equipo.marca}"
                          th:data-modelo="${equipo.modelo}"
                          th:data-numero-serie="${equipo.numeroSerie}"
                          th:data-numero-inventario="${equipo.numeroInventario}"
                          th:data-estado="${equipo.estado}"
                          th:data-observaciones="${equipo.observaciones}">
                    <i class="bi bi-eye"></i> Detalles
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-warning me-1" 
                          onclick="editarEquipoExistente(this)"
                          th:data-id="${equipo.id}"
                          th:data-tipo="${equipo.tipo}"
                          th:data-marca="${equipo.marca}"
                          th:data-modelo="${equipo.modelo}"
                          th:data-numero-serie="${equipo.numeroSerie}"
                          th:data-numero-inventario="${equipo.numeroInventario}"
                          th:data-estado="${equipo.estado}"
                          th:data-observaciones="${equipo.observaciones}">
                    <i class="bi bi-pencil"></i> Editar
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger" 
                          onclick="desasignarEquipoFromButton(this)"
                          th:data-equipo-id="${equipo.id}"
                          th:data-equipo-tipo="${equipo.tipo}">
                    <i class="bi bi-x-circle"></i> Desasignar
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Botón para asignar equipos existentes -->
            <div class="d-flex gap-2 mb-3">
              <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#asignarEquipoModal">
                <i class="bi bi-link me-2"></i> Asignar Equipo Existente
              </button>
              <small class="text-muted align-self-center ms-3">
                <i class="bi bi-info-circle me-1"></i>
                Selecciona equipos disponibles del inventario para asignar al usuario
              </small>
            </div>
            
            <!-- Campo oculto para JSON de equipos -->
            <input type="hidden" name="equiposJson" id="equiposJsonField" value="[]">
            
            <!-- Lista de equipos a agregar -->
            <div id="nuevosEquipos" class="mb-3" style="display: none;">
              <h6>Equipos a agregar:</h6>
              <div id="listaEquiposNuevos"></div>
            </div>
            

          </div>

          <div class="text-center">
            <button type="submit" class="btn btn-warning btn-lg">
              Actualizar Usuario
            </button>
            <a th:href="@{/usuarios/nuevo}" class="btn btn-secondary btn-lg ms-2">
              Volver
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal para agregar equipo -->
  <div class="modal fade" id="equipoModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Agregar Equipo Informático</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="equipoForm">
            <div class="mb-3">
              <label class="form-label">Tipo *</label>
              <select class="form-control" id="equipoTipo" required onchange="toggleEspecificacionFieldEdit()">
                <option value="">Seleccionar</option>
                <option value="CPU">CPU</option>
                <option value="MONITOR">Monitor</option>
                <option value="NOTEBOOK">Notebook</option>
                <option value="ONLY_ONE">Only One</option>
                <option value="MOUSE">Mouse</option>
                <option value="TECLADO">Teclado</option>
                <option value="VINCHA">Vincha</option>
                <option value="CABLES">Cables (especificar)</option>
                <option value="ROUTER">Router</option>
                <option value="SWITCH">Switch</option>
                <option value="SERVIDORES">Servidores</option>
                <option value="PROYECTORES">Proyectores</option>
                <option value="OTROS">Otros (especificar)</option>
              </select>
            </div>
            <div id="especificacionFieldEdit" class="mb-3" style="display: none;">
              <label class="form-label">Especificar *</label>
              <input type="text" id="equipoEspecificacion" class="form-control" placeholder="Especifique el tipo de equipo..." />
            </div>
            <div class="mb-3">
              <label class="form-label">Marca *</label>
              <input type="text" class="form-control" id="equipoMarca" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Modelo *</label>
              <input type="text" class="form-control" id="equipoModelo" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Número de Serie</label>
              <input type="text" class="form-control" id="equipoNumeroSerie">
            </div>
            <div class="mb-3">
              <label class="form-label">Número de Inventario</label>
              <input type="text" class="form-control" id="equipoNumeroInventario">
            </div>
            <div class="mb-3">
              <label class="form-label">Estado *</label>
              <select class="form-control" id="equipoEstado" required>
                <option value="ACTIVO">ACTIVO</option>
                <option value="INACTIVO">INACTIVO</option>
                <option value="EN_REPARACION">EN REPARACIÓN</option>
                <option value="DADO_DE_BAJA">DADO DE BAJA</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Observaciones</label>
              <textarea class="form-control" id="equipoObservaciones" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="agregarEquipo()">Agregar Equipo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para ver detalles del equipo -->
  <div class="modal fade" id="detallesModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalles del Equipo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>ID:</strong> <span id="detalleId"></span></p>
              <p><strong>Tipo:</strong> <span id="detalleTipo"></span></p>
              <p><strong>Marca:</strong> <span id="detalleMarca"></span></p>
              <p><strong>Modelo:</strong> <span id="detalleModelo"></span></p>
            </div>
            <div class="col-md-6">
              <p><strong>Número de Serie:</strong> <span id="detalleNumeroSerie"></span></p>
              <p><strong>Número de Inventario:</strong> <span id="detalleNumeroInventario"></span></p>
              <p><strong>Estado:</strong> <span id="detalleEstado"></span></p>
              <p><strong>Observaciones:</strong> <span id="detalleObservaciones"></span></p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para asignar equipo existente -->
  <div class="modal fade" id="asignarEquipoModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-link me-2"></i>Asignar Equipo Existente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Filtros por tipo de equipo -->
          <div class="mb-4">
            <h6 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtrar por Tipo de Equipo</h6>
            <div class="row">
              <div class="col-md-12">
                <div class="btn-group-vertical d-md-none w-100 mb-3" role="group">
                  <button type="button" class="btn btn-outline-primary active" onclick="filtrarPorTipo('TODOS')" id="btn-TODOS">
                    <i class="bi bi-grid me-2"></i>Seleccionar
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('CPU')" id="btn-CPU">
                    <i class="bi bi-cpu me-2"></i>CPU
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('MONITOR')" id="btn-MONITOR">
                    <i class="bi bi-display me-2"></i>Monitor
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('NOTEBOOK')" id="btn-NOTEBOOK">
                    <i class="bi bi-laptop me-2"></i>Notebook
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('ONLY_ONE')" id="btn-ONLY_ONE">
                    <i class="bi bi-1-circle me-2"></i>Only One
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('MOUSE')" id="btn-MOUSE">
                    <i class="bi bi-mouse me-2"></i>Mouse
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('TECLADO')" id="btn-TECLADO">
                    <i class="bi bi-keyboard me-2"></i>Teclado
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('VINCHA')" id="btn-VINCHA">
                    <i class="bi bi-headphones me-2"></i>Vincha
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('CABLES')" id="btn-CABLES">
                    <i class="bi bi-bezier me-2"></i>Cables (especificar)
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('ROUTER')" id="btn-ROUTER">
                    <i class="bi bi-router me-2"></i>Router
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('SWITCH')" id="btn-SWITCH">
                    <i class="bi bi-diagram-3 me-2"></i>Switch
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('SERVIDORES')" id="btn-SERVIDORES">
                    <i class="bi bi-server me-2"></i>Servidores
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('PROYECTORES')" id="btn-PROYECTORES">
                    <i class="bi bi-projector me-2"></i>Proyectores
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('OTROS')" id="btn-OTROS">
                    <i class="bi bi-three-dots me-2"></i>Otros (especificar)
                  </button>
                </div>
                
                <div class="btn-group d-none d-md-flex flex-wrap" role="group">
                  <button type="button" class="btn btn-outline-primary active" onclick="filtrarPorTipo('TODOS')" id="btn-TODOS-desktop">
                    <i class="bi bi-grid me-1"></i>Seleccionar
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('CPU')" id="btn-CPU-desktop">
                    <i class="bi bi-cpu me-1"></i>CPU
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('MONITOR')" id="btn-MONITOR-desktop">
                    <i class="bi bi-display me-1"></i>Monitor
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('NOTEBOOK')" id="btn-NOTEBOOK-desktop">
                    <i class="bi bi-laptop me-1"></i>Notebook
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('ONLY_ONE')" id="btn-ONLY_ONE-desktop">
                    <i class="bi bi-1-circle me-1"></i>Only One
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('MOUSE')" id="btn-MOUSE-desktop">
                    <i class="bi bi-mouse me-1"></i>Mouse
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('TECLADO')" id="btn-TECLADO-desktop">
                    <i class="bi bi-keyboard me-1"></i>Teclado
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('VINCHA')" id="btn-VINCHA-desktop">
                    <i class="bi bi-headphones me-1"></i>Vincha
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('CABLES')" id="btn-CABLES-desktop">
                    <i class="bi bi-bezier me-1"></i>Cables
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('ROUTER')" id="btn-ROUTER-desktop">
                    <i class="bi bi-router me-1"></i>Router
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('SWITCH')" id="btn-SWITCH-desktop">
                    <i class="bi bi-diagram-3 me-1"></i>Switch
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('SERVIDORES')" id="btn-SERVIDORES-desktop">
                    <i class="bi bi-server me-1"></i>Servidores
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('PROYECTORES')" id="btn-PROYECTORES-desktop">
                    <i class="bi bi-projector me-1"></i>Proyectores
                  </button>
                  <button type="button" class="btn btn-outline-primary" onclick="filtrarPorTipo('OTROS')" id="btn-OTROS-desktop">
                    <i class="bi bi-three-dots me-1"></i>Otros
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Campo de búsqueda en tiempo real -->
          <div class="mb-3">
            <div class="input-group">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" 
                     class="form-control" 
                     id="buscarEquipo" 
                     placeholder="Buscar por número de serie, inventario, marca o modelo..." 
                     onkeyup="aplicarFiltros()">
              <button class="btn btn-outline-secondary" type="button" onclick="limpiarBusqueda()">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            <small class="text-muted">
              <i class="bi bi-lightbulb me-1"></i>
              Busca equipos por número de serie, inventario, marca o modelo en tiempo real
            </small>
          </div>
          
          <!-- Contador de resultados -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0" id="contadorResultados">
                <i class="bi bi-laptop me-2"></i>Equipos Disponibles
              </h6>
              <small class="text-muted" id="tipoSeleccionado">Mostrando todos los tipos</small>
            </div>
            <hr class="my-2">
          </div>
          
          <!-- Lista de equipos -->
          <div id="equiposDisponibles" style="max-height: 400px; overflow-y: auto;">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando equipos disponibles...</span>
              </div>
              <p class="mt-2 text-muted">Cargando equipos disponibles...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let equiposNuevos = [];
    
    function agregarEquipo() {
      const tipo = document.getElementById('equipoTipo').value;
      const marca = document.getElementById('equipoMarca').value;
      const modelo = document.getElementById('equipoModelo').value;
      const numeroSerie = document.getElementById('equipoNumeroSerie').value;
      const numeroInventario = document.getElementById('equipoNumeroInventario').value;
      const estado = document.getElementById('equipoEstado').value;
      const observaciones = document.getElementById('equipoObservaciones').value;
      
      if (!tipo || !marca || !modelo || !estado) {
        alert('Por favor complete los campos obligatorios (*)');
        return;
      }
      
      const equipo = {
        tipo: tipo,
        marca: marca,
        modelo: modelo,
        numeroSerie: numeroSerie,
        numeroInventario: numeroInventario,
        estado: estado,
        observaciones: observaciones
      };
      
      equiposNuevos.push(equipo);
      actualizarListaEquipos();
      actualizarJsonField();
      
      // Limpiar formulario
      document.getElementById('equipoForm').reset();
      
      // Cerrar modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('equipoModal'));
      modal.hide();
    }
    
    function actualizarListaEquipos() {
      const lista = document.getElementById('listaEquiposNuevos');
      const container = document.getElementById('nuevosEquipos');
      
      if (equiposNuevos.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      lista.innerHTML = '';
      
      equiposNuevos.forEach((equipo, index) => {
        const equipoDiv = document.createElement('div');
        equipoDiv.className = 'alert alert-success d-flex justify-content-between align-items-center mb-2';
        equipoDiv.innerHTML = `
          <div>
            <strong>${equipo.tipo}</strong> - ${equipo.marca} ${equipo.modelo}<br>
            <small class="text-muted">
              Serie: ${equipo.numeroSerie || 'N/A'} | Estado: ${equipo.estado}
            </small>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarEquipoNuevo(${index})">
            <i class="bi bi-trash"></i>
          </button>
        `;
        lista.appendChild(equipoDiv);
      });
    }
    
    function eliminarEquipoNuevo(index) {
      equiposNuevos.splice(index, 1);
      actualizarListaEquipos();
      actualizarJsonField();
    }
    
    function actualizarJsonField() {
      document.getElementById('equiposJsonField').value = JSON.stringify(equiposNuevos);
    }
    
    // Funciones para manejo de archivos
    let selectedFiles = [];
    
    function addFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Por favor selecciona un archivo');
        return;
      }
      
      // Verificar si el archivo ya fue agregado
      const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
      if (exists) {
        alert('Este archivo ya fue agregado');
        return;
      }
      
      selectedFiles.push(file);
      updateFileList();
      updateHiddenInput();
      
      // Limpiar el input
      fileInput.value = '';
    }
    
    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFileList();
      updateHiddenInput();
    }
    
    function clearAllFiles() {
      selectedFiles = [];
      updateFileList();
      updateHiddenInput();
    }
    
    function updateFileList() {
      const fileList = document.getElementById('fileList');
      
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '<small class="text-muted">No hay archivos seleccionados</small>';
        return;
      }
      
      let html = '';
      selectedFiles.forEach((file, index) => {
        const fileSize = (file.size / 1024).toFixed(1) + ' KB';
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white border rounded">
            <div>
              <strong>${file.name}</strong><br>
              <small class="text-muted">${fileSize}</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
      });
      
      fileList.innerHTML = html;
    }
    
    function updateHiddenInput() {
      const hiddenInput = document.getElementById('hiddenFileInput');
      const dt = new DataTransfer();
      
      selectedFiles.forEach(file => {
        dt.items.add(file);
      });
      
      hiddenInput.files = dt.files;
    }
    
    // Función para mostrar/ocultar campo de especificación
    function toggleEspecificacionFieldEdit() {
      const tipoSelect = document.getElementById('equipoTipo');
      const especificacionField = document.getElementById('especificacionFieldEdit');
      const especificacionInput = document.getElementById('equipoEspecificacion');
      
      if (tipoSelect.value === 'CABLES' || tipoSelect.value === 'OTROS') {
        especificacionField.style.display = 'block';
        especificacionInput.required = true;
      } else {
        especificacionField.style.display = 'none';
        especificacionInput.required = false;
        especificacionInput.value = '';
      }
    }
    
    // Función para ver detalles de un equipo
    function verDetallesEquipo(button) {
      const id = button.getAttribute('data-id');
      const tipo = button.getAttribute('data-tipo');
      const marca = button.getAttribute('data-marca');
      const modelo = button.getAttribute('data-modelo');
      const numeroSerie = button.getAttribute('data-numero-serie');
      const numeroInventario = button.getAttribute('data-numero-inventario');
      const estado = button.getAttribute('data-estado');
      const observaciones = button.getAttribute('data-observaciones');
      
      document.getElementById('detalleId').textContent = id;
      document.getElementById('detalleTipo').textContent = tipo;
      document.getElementById('detalleMarca').textContent = marca;
      document.getElementById('detalleModelo').textContent = modelo;
      document.getElementById('detalleNumeroSerie').textContent = numeroSerie || 'N/A';
      document.getElementById('detalleNumeroInventario').textContent = numeroInventario || 'N/A';
      document.getElementById('detalleEstado').textContent = estado;
      document.getElementById('detalleObservaciones').textContent = observaciones || 'Ninguna';
      
      var modal = new bootstrap.Modal(document.getElementById('detallesModal'));
      modal.show();
    }
    
    // Función para editar un equipo existente
    function editarEquipoExistente(button) {
      const id = button.getAttribute('data-id');
      const tipo = button.getAttribute('data-tipo');
      const marca = button.getAttribute('data-marca');
      const modelo = button.getAttribute('data-modelo');
      const numeroSerie = button.getAttribute('data-numero-serie');
      const numeroInventario = button.getAttribute('data-numero-inventario');
      const estado = button.getAttribute('data-estado');
      const observaciones = button.getAttribute('data-observaciones');
      // Crear modal de edición dinámicamente
      const modalHtml = `
        <div class="modal fade" id="editarModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Editar Equipo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="editarEquipoForm">
                  <input type="hidden" id="editEquipoId" value="${id}">
                  
                  <div class="mb-3">
                    <label class="form-label">Tipo *</label>
                    <select class="form-control" id="editEquipoTipo" required onchange="toggleEspecificacionFieldEditModal()">
                      <option value="">Seleccionar</option>
                      <option value="CPU" ${tipo === 'CPU' ? 'selected' : ''}>CPU</option>
                      <option value="MONITOR" ${tipo === 'MONITOR' ? 'selected' : ''}>Monitor</option>
                      <option value="NOTEBOOK" ${tipo === 'NOTEBOOK' ? 'selected' : ''}>Notebook</option>
                      <option value="ONLY_ONE" ${tipo === 'ONLY_ONE' ? 'selected' : ''}>Only One</option>
                      <option value="MOUSE" ${tipo === 'MOUSE' ? 'selected' : ''}>Mouse</option>
                      <option value="TECLADO" ${tipo === 'TECLADO' ? 'selected' : ''}>Teclado</option>
                      <option value="VINCHA" ${tipo === 'VINCHA' ? 'selected' : ''}>Vincha</option>
                      <option value="CABLES" ${tipo === 'CABLES' ? 'selected' : ''}>Cables (especificar)</option>
                      <option value="ROUTER" ${tipo === 'ROUTER' ? 'selected' : ''}>Router</option>
                      <option value="SWITCH" ${tipo === 'SWITCH' ? 'selected' : ''}>Switch</option>
                      <option value="SERVIDORES" ${tipo === 'SERVIDORES' ? 'selected' : ''}>Servidores</option>
                      <option value="PROYECTORES" ${tipo === 'PROYECTORES' ? 'selected' : ''}>Proyectores</option>
                      <option value="OTROS" ${tipo === 'OTROS' ? 'selected' : ''}>Otros (especificar)</option>
                    </select>
                  </div>
                  
                  <div id="especificacionFieldEditModal" class="mb-3" style="display: ${(tipo === 'CABLES' || tipo === 'OTROS') ? 'block' : 'none'}">
                    <label class="form-label">Especificar *</label>
                    <input type="text" id="editEquipoEspecificacion" class="form-control" placeholder="Especifique el tipo de equipo..." 
                           oninput="this.value = this.value.toUpperCase()" 
                           style="text-transform: uppercase;" />
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Marca *</label>
                    <input type="text" class="form-control" id="editEquipoMarca" value="${marca}" required 
                           oninput="this.value = this.value.toUpperCase()" 
                           style="text-transform: uppercase;">
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Modelo *</label>
                    <input type="text" class="form-control" id="editEquipoModelo" value="${modelo}" required 
                           oninput="this.value = this.value.toUpperCase()" 
                           style="text-transform: uppercase;">
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Número de Serie</label>
                    <input type="text" class="form-control" id="editEquipoNumeroSerie" value="${numeroSerie !== 'N/A' ? numeroSerie : ''}" 
                           oninput="this.value = this.value.toUpperCase()" 
                           style="text-transform: uppercase;">
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Número de Inventario</label>
                    <input type="text" class="form-control" id="editEquipoNumeroInventario" value="${numeroInventario !== 'N/A' ? numeroInventario : ''}" 
                           oninput="this.value = this.value.toUpperCase()" 
                           style="text-transform: uppercase;">
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <select class="form-control" id="editEquipoEstado">
                      <option value="ACTIVO" ${estado === 'ACTIVO' ? 'selected' : ''}>Activo</option>
                      <option value="EN_REPARACION" ${estado === 'EN_REPARACION' ? 'selected' : ''}>En Reparación</option>
                      <option value="DADO_DE_BAJA" ${estado === 'DADO_DE_BAJA' ? 'selected' : ''}>Dado de Baja</option>
                      <option value="EN_MANTENIMIENTO" ${estado === 'EN_MANTENIMIENTO' ? 'selected' : ''}>En Mantenimiento</option>
                    </select>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-control" id="editEquipoObservaciones" rows="3" 
                              oninput="this.value = this.value.toUpperCase()" 
                              style="text-transform: uppercase;">${observaciones !== 'Ninguna' ? observaciones : ''}</textarea>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarEdicionEquipo()">Guardar Cambios</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal anterior si existe
      const existingModal = document.getElementById('editarModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Agregar nuevo modal
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('editarModal'));
      modal.show();
    }
    
    // Función para mostrar/ocultar campo de especificación en modal de edición
    function toggleEspecificacionFieldEditModal() {
      const tipoSelect = document.getElementById('editEquipoTipo');
      const especificacionField = document.getElementById('especificacionFieldEditModal');
      const especificacionInput = document.getElementById('editEquipoEspecificacion');
      
      if (tipoSelect.value === 'CABLES' || tipoSelect.value === 'OTROS') {
        especificacionField.style.display = 'block';
        especificacionInput.required = true;
      } else {
        especificacionField.style.display = 'none';
        especificacionInput.required = false;
        especificacionInput.value = '';
      }
    }
    
    // Función para guardar los cambios del equipo editado
    function guardarEdicionEquipo() {
      const id = document.getElementById('editEquipoId').value;
      const tipo = document.getElementById('editEquipoTipo').value;
      const marca = document.getElementById('editEquipoMarca').value;
      const modelo = document.getElementById('editEquipoModelo').value;
      const numeroSerie = document.getElementById('editEquipoNumeroSerie').value;
      const numeroInventario = document.getElementById('editEquipoNumeroInventario').value;
      const estado = document.getElementById('editEquipoEstado').value;
      const observaciones = document.getElementById('editEquipoObservaciones').value;
      
      if (!tipo || !marca || !modelo) {
        alert('Por favor complete los campos obligatorios (*)');
        return;
      }
      
      // Crear objeto con los datos actualizados
      const equipoActualizado = {
        tipo: tipo,
        marca: marca,
        modelo: modelo,
        numeroSerie: numeroSerie,
        numeroInventario: numeroInventario,
        estado: estado,
        observaciones: observaciones
      };
      
      // Hacer petición PUT al endpoint de actualización
      fetch(`/api/equipos/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(equipoActualizado)
      })
      .then(response => {
        if (response.ok) {
          alert('Equipo actualizado correctamente');
          // Cerrar modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('editarModal'));
          modal.hide();
          // Recargar la página para mostrar los cambios
          location.reload();
        } else {
          throw new Error('Error al actualizar el equipo');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar el equipo: ' + error.message);
      });
    }
    
    // ===== FUNCIONES PARA ASIGNAR EQUIPOS EXISTENTES =====
    
    // Cargar equipos disponibles cuando se abre el modal
    document.getElementById('asignarEquipoModal').addEventListener('show.bs.modal', function () {
      cargarEquiposDisponibles();
    });
    
    // Variables globales para el modal de asignar equipo
    let equiposDisponiblesGlobal = [];
    let tipoSeleccionado = 'TODOS';
    
    // Función helper para mapear tipos del frontend al backend
    function mapearTipoFrontendABackend(tipoFrontend) {
      const mapeo = {
        'CPU': 'CPU',
        'MONITOR': 'Monitor',
        'NOTEBOOK': 'Notebook', 
        'ONLY_ONE': 'Only One',
        'MOUSE': 'Mouse',
        'TECLADO': 'Teclado',
        'VINCHA': 'Vincha',
        'CABLES': 'Cables (especificar)',
        'ROUTER': 'Router',
        'SWITCH': 'Switch',
        'SERVIDORES': 'Servidores',
        'PROYECTORES': 'Proyectores',
        'OTROS': 'Otros (especificar)'
      };
      return mapeo[tipoFrontend] || tipoFrontend;
    }
    
    // Inicializar cuando se abre el modal
    document.addEventListener('DOMContentLoaded', function() {
      const modalElement = document.getElementById('asignarEquipoModal');
      if (modalElement) {
        modalElement.addEventListener('shown.bs.modal', function () {
          cargarEquiposDisponibles();
        });
      }
    });
    
    function cargarEquiposDisponibles() {
      const container = document.getElementById('equiposDisponibles');
      
      // Limpiar campo de búsqueda
      document.getElementById('buscarEquipo').value = '';
      
      // Mostrar spinner de carga
      container.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando equipos disponibles...</span>
          </div>
          <p class="mt-2 text-muted">Cargando equipos disponibles...</p>
        </div>
      `;
      
      // Obtener todos los equipos
      fetch('/equipos/debug/reporte')
        .then(response => response.json())
        .then(data => {
          console.log('Datos recibidos del backend:', data); // Debug
          
          // El backend devuelve { totalEquipos: X, equipos: [...] }
          const equipos = data.equipos || [];
          
          // Filtrar solo equipos sin asignar (usuario === "Sin asignar")
          equiposDisponiblesGlobal = equipos.filter(equipo => 
            !equipo.usuario || equipo.usuario === 'Sin asignar' || equipo.usuario.trim() === ''
          );
          
          console.log('Equipos disponibles filtrados:', equiposDisponiblesGlobal); // Debug
          aplicarFiltros();
        })
        .catch(error => {
          console.error('Error cargando equipos:', error);
          document.getElementById('equiposDisponibles').innerHTML = 
            '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error cargando equipos disponibles</div>';
        });
    }
    
    // Función para filtrar por tipo de equipo
    function filtrarPorTipo(tipo) {
      tipoSeleccionado = tipo;
      
      // Actualizar botones activos (mobile y desktop)
      document.querySelectorAll('[id^="btn-"]').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const btnMobile = document.getElementById(`btn-${tipo}`);
      const btnDesktop = document.getElementById(`btn-${tipo}-desktop`);
      
      if (btnMobile) btnMobile.classList.add('active');
      if (btnDesktop) btnDesktop.classList.add('active');
      
      // Actualizar texto indicador
      const tipoTexto = tipo === 'TODOS' ? 'todos los tipos' : tipo.toLowerCase();
      document.getElementById('tipoSeleccionado').textContent = `Mostrando: ${tipoTexto}`;
      
      aplicarFiltros();
    }
    
    // Función para aplicar todos los filtros (tipo + búsqueda)
    function aplicarFiltros() {
      const busqueda = document.getElementById('buscarEquipo').value.toLowerCase();
      
      let equiposFiltrados = equiposDisponiblesGlobal;
      
      // Filtrar por tipo
      if (tipoSeleccionado !== 'TODOS') {
        equiposFiltrados = equiposFiltrados.filter(equipo => {
          // Mapear tipos del frontend a backend para comparación
          const tipoBackend = mapearTipoFrontendABackend(tipoSeleccionado);
          return equipo.tipo === tipoBackend || equipo.tipo === tipoSeleccionado;
        });
      }
      
      // Filtrar por búsqueda
      if (busqueda.trim() !== '') {
        equiposFiltrados = equiposFiltrados.filter(equipo => {
          const numeroSerie = (equipo.numeroSerie || '').toLowerCase();
          const numeroInventario = (equipo.numeroInventario || '').toLowerCase();
          const marca = (equipo.marca || '').toLowerCase();
          const modelo = (equipo.modelo || '').toLowerCase();
          const tipo = (equipo.tipo || '').toLowerCase();
          const site = (equipo.site || '').toLowerCase();
          
          return numeroSerie.includes(busqueda) || 
                 numeroInventario.includes(busqueda) ||
                 marca.includes(busqueda) ||
                 modelo.includes(busqueda) ||
                 tipo.includes(busqueda) ||
                 site.includes(busqueda);
        });
      }
      
      mostrarEquiposDisponibles(equiposFiltrados);
      actualizarContador(equiposFiltrados.length, equiposDisponiblesGlobal.length);
    }
    
    // Función para actualizar contador de resultados
    function actualizarContador(mostrados, total) {
      const contador = document.getElementById('contadorResultados');
      if (mostrados === total) {
        contador.innerHTML = `<i class="bi bi-laptop me-2"></i>Equipos Disponibles (${total})`;
      } else {
        contador.innerHTML = `<i class="bi bi-funnel me-2"></i>Equipos Filtrados (${mostrados} de ${total})`;
      }
    }
    
    // Función para mostrar equipos disponibles
    function mostrarEquiposDisponibles(equipos) {
      const container = document.getElementById('equiposDisponibles');
      
      if (equipos.length === 0) {
        const mensaje = tipoSeleccionado === 'TODOS' ? 
          'No hay equipos disponibles' : 
          `No hay equipos de tipo ${tipoSeleccionado} disponibles`;
          
        container.innerHTML = `
          <div class="text-center py-4">
            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
            <h6 class="text-muted mt-2">${mensaje}</h6>
            <p class="text-muted small">Prueba con otro tipo de equipo o limpia los filtros.</p>
            <button class="btn btn-outline-primary btn-sm" onclick="limpiarFiltros()">
              <i class="bi bi-arrow-clockwise me-2"></i>Limpiar Filtros
            </button>
          </div>
        `;
        return;
      }
      
      let html = '<div class="row">';
      equipos.forEach(equipo => {
        const numeroSerie = equipo.numeroSerie || 'N/A';
        const numeroInventario = equipo.numeroInventario || 'N/A';
        const estado = equipo.estado || 'ACTIVO';
        const estadoClass = estado === 'ACTIVO' ? 'success' : 'warning';
        
        // Icono según tipo de equipo
        let icono = 'bi-laptop';
        const tipoEquipo = equipo.tipo.toUpperCase();
        switch(tipoEquipo) {
          case 'CPU': icono = 'bi-cpu'; break;
          case 'MONITOR': icono = 'bi-display'; break;
          case 'NOTEBOOK': icono = 'bi-laptop'; break;
          case 'ONLY ONE': icono = 'bi-1-circle'; break;
          case 'MOUSE': icono = 'bi-mouse'; break;
          case 'TECLADO': icono = 'bi-keyboard'; break;
          case 'VINCHA': icono = 'bi-headphones'; break;
          case 'CABLES': 
          case 'CABLES (ESPECIFICAR)': icono = 'bi-bezier'; break;
          case 'ROUTER': icono = 'bi-router'; break;
          case 'SWITCH': icono = 'bi-diagram-3'; break;
          case 'SERVIDORES': icono = 'bi-server'; break;
          case 'PROYECTORES': icono = 'bi-projector'; break;
          case 'OTROS':
          case 'OTROS (ESPECIFICAR)': icono = 'bi-three-dots'; break;
          default: icono = 'bi-laptop';
        }
        
        html += `
          <div class="col-lg-6 col-xl-4 mb-3">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-0">
                    <i class="${icono} me-2 text-primary"></i>
                    ${equipo.tipo}
                  </h6>
                  <span class="badge bg-${estadoClass}">${estado}</span>
                </div>
                
                <p class="card-text mb-2">
                  <strong>${equipo.marca}</strong> ${equipo.modelo}<br>
                  <small class="text-muted">
                    <i class="bi bi-geo-alt me-1"></i>${equipo.site} | ID: ${equipo.id}
                  </small>
                </p>
                
                <div class="mb-3">
                  <div class="d-flex align-items-center mb-1">
                    <i class="bi bi-hash text-info me-2"></i>
                    <small><strong>Serie:</strong> ${numeroSerie}</small>
                  </div>
                  <div class="d-flex align-items-center">
                    <i class="bi bi-tag text-warning me-2"></i>
                    <small><strong>Inventario:</strong> ${numeroInventario}</small>
                  </div>
                </div>
                
                <button class="btn btn-primary btn-sm w-100" 
                        onclick="asignarEquipoExistente(${equipo.id}, '${equipo.tipo}', '${equipo.marca}', '${equipo.modelo}', '${numeroSerie}', '${numeroInventario}', '${estado}')">
                  <i class="bi bi-check-circle me-2"></i>Asignar
                </button>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }
    
    // Función para limpiar la búsqueda
    function limpiarBusqueda() {
      document.getElementById('buscarEquipo').value = '';
      aplicarFiltros();
    }
    
    // Función para limpiar todos los filtros
    function limpiarFiltros() {
      document.getElementById('buscarEquipo').value = '';
      filtrarPorTipo('TODOS');
    }
    
    // Función para asignar equipo existente (corregida)
    function asignarEquipoExistente(id, tipo, marca, modelo, numeroSerie, numeroInventario, estado) {
      // Obtener el legajo del usuario desde el formulario
      const legajoUsuario = document.querySelector('input[name="legajo"]').value;
      
      if (!legajoUsuario) {
        mostrarMensaje('error', '❌ No se pudo obtener el legajo del usuario.');
        return;
      }
      
      // Crear FormData para enviar como @RequestParam
      const formData = new FormData();
      formData.append('equipoId', id);
      formData.append('legajoUsuario', legajoUsuario);
      
      // Enviar solicitud para asignar el equipo
      fetch('/usuarios/asignar-equipo', {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => {
        if (response.ok) {
          return response.text();
        } else {
          return response.text().then(text => {
            throw new Error(text || 'Error al asignar el equipo');
          });
        }
      })
      .then(message => {
        // Mostrar mensaje de éxito
        mostrarMensaje('success', `✅ Equipo ${tipo} asignado correctamente`);
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('asignarEquipoModal'));
        modal.hide();
        
        // Recargar la página para mostrar el equipo asignado
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('error', `❌ Error al asignar el equipo: ${error.message}`);
      });
    }
    
    // Función para mostrar mensajes de estado
    function mostrarMensaje(tipo, mensaje) {
      const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          ${mensaje}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      // Insertar el mensaje al inicio del modal body
      const modalBody = document.querySelector('#asignarEquipoModal .modal-body');
      modalBody.insertAdjacentHTML('afterbegin', alertHtml);
      
      // Auto-remover después de 5 segundos
      setTimeout(() => {
        const alert = modalBody.querySelector('.alert');
        if (alert) {
          alert.remove();
        }
      }, 5000);
    }
    
    // Función para asignar equipo a usuario
    function asignarEquipoAUsuario(equipoId, tipoEquipo, siteEquipo) {
      const legajoUsuario = document.querySelector('input[name="legajo"]').value;
      
      if (!legajoUsuario) {
        alert('Error: No se pudo obtener el legajo del usuario');
        return;
      }
      
      if (!confirm(`¿Asignar el equipo ${tipoEquipo} (${siteEquipo}) al usuario?`)) {
        return;
      }
      
      // Mostrar indicador de carga
      const button = event.target.closest('button');
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Asignando...';
      button.disabled = true;
      
      // Crear FormData para enviar la petición
      const formData = new FormData();
      formData.append('equipoId', equipoId);
      formData.append('legajoUsuario', legajoUsuario);
      
      fetch('/usuarios/asignar-equipo', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          return response.text();
        } else {
          throw new Error('Error al asignar equipo');
        }
      })
      .then(message => {
        alert('✅ ' + message);
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('asignarEquipoModal'));
        modal.hide();
        
        // Recargar la página para mostrar el equipo asignado
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('❌ Error al asignar equipo: ' + error.message);
        
        // Restaurar botón
        button.innerHTML = originalText;
        button.disabled = false;
      });
    }
    
    // ===== FUNCIÓN PARA DESASIGNAR EQUIPOS =====
    
    function desasignarEquipoFromButton(button) {
      const equipoId = button.getAttribute('data-equipo-id');
      const tipoEquipo = button.getAttribute('data-equipo-tipo');
      
      if (!equipoId || !tipoEquipo) {
        alert('❌ Error: No se pudieron obtener los datos del equipo');
        return;
      }
      
      desasignarEquipo(equipoId, tipoEquipo, button);
    }
    
    function desasignarEquipo(equipoId, tipoEquipo, button) {
      if (!confirm(`¿Desasignar el equipo ${tipoEquipo} del usuario?\n\nEl equipo quedará disponible para ser asignado a otro usuario.`)) {
        return;
      }
      
      // Mostrar indicador de carga
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Desasignando...';
      button.disabled = true;
      
      // Crear FormData para enviar la petición
      const formData = new FormData();
      formData.append('equipoId', equipoId);
      
      fetch('/usuarios/desasignar-equipo', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          return response.text();
        } else {
          throw new Error('Error al desasignar equipo');
        }
      })
      .then(message => {
        alert('✅ ' + message);
        
        // Recargar la página para mostrar los cambios
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('❌ Error al desasignar equipo: ' + error.message);
        
        // Restaurar botón
        button.innerHTML = originalText;
        button.disabled = false;
      });
    }
  </script>
</body>
</html>
